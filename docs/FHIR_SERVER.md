# FHIR Server Documentation

## Overview

The FHIR Server provides a FHIR R4 compliant REST API for healthcare data exchange, built on Spring Boot 3.1.0 and HAPI FHIR 6.6.0.

## Technology Stack

- **Framework**: Spring Boot 3.1.0
- **FHIR Library**: HAPI FHIR 6.6.0
- **Java Version**: 17
- **Database**: PostgreSQL 15
- **ORM**: Hibernate/JPA
- **Security**: Spring Security

## FHIR Compliance

- **FHIR Version**: R4 (4.0.1)
- **Resource Types**: Patient (extensible)
- **Interactions**: read, search-type
- **Formats**: JSON, XML

## Configuration

### Application Properties (application.yml)

```yaml
spring:
  application:
    name: epic-fhir-server
  
  datasource:
    url: jdbc:postgresql://postgres:5432/epic_db
    username: epic_user
    password: epic_password
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

server:
  port: 8084

logging:
  level:
    ca.uhn.fhir: INFO
    com.epicehr.fhir: DEBUG
```

### Security Configuration

- **Authentication**: HTTP Basic
- **Default Credentials**: admin:admin123
- **CORS**: Enabled for cross-origin requests

## API Endpoints

### FHIR Metadata
```
GET /fhir/metadata
Authorization: Basic admin:admin123
Accept: application/json
```

**Response**: FHIR CapabilityStatement
```json
{
  "resourceType": "CapabilityStatement",
  "id": "epic-fhir-server",
  "name": "EPIC EHR FHIR Server",
  "version": "1.0.0",
  "status": "active",
  "fhirVersion": "4.0.1",
  "format": ["json", "xml"],
  "rest": [{
    "mode": "server",
    "resource": [{
      "type": "Patient",
      "interaction": [
        {"code": "read"},
        {"code": "search-type"}
      ]
    }]
  }]
}
```

### Patient Resources

#### Get All Patients
```
GET /fhir/Patient
Authorization: Basic admin:admin123
```

**Response**: FHIR Bundle
```json
{
  "resourceType": "Bundle",
  "type": "searchset",
  "total": 2,
  "entry": [
    {
      "resource": {
        "resourceType": "Patient",
        "id": "1",
        "identifier": [{
          "system": "http://epic.com/patient-id",
          "value": "EPIC123"
        }],
        "name": [{
          "family": "Doe",
          "given": ["John"]
        }]
      }
    }
  ]
}
```

#### Get Patient by ID
```
GET /fhir/Patient/{id}
Authorization: Basic admin:admin123
```

**Response**: FHIR Patient Resource
```json
{
  "resourceType": "Patient",
  "id": "1",
  "identifier": [{
    "system": "http://epic.com/patient-id",
    "value": "EPIC123"
  }],
  "name": [{
    "family": "Doe",
    "given": ["John"]
  }]
}
```

### Health Endpoints

#### Custom Health Check
```
GET /fhir/health
Authorization: Basic admin:admin123
```

**Response**:
```json
{
  "status": "UP",
  "server": "EPIC EHR FHIR Server",
  "version": "1.0.0"
}
```

#### Spring Boot Actuator
```
GET /actuator/health
Authorization: Basic admin:admin123
```

**Response**:
```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "validationQuery": "isValid()"
      }
    },
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 62671097856,
        "free": 53668671488,
        "threshold": 10485760
      }
    }
  }
}
```

## Sample Data

The FHIR server includes sample patient data for testing:

### Patient 1: John Doe
- **ID**: 1
- **EPIC ID**: EPIC123
- **Name**: John Doe

### Patient 2: Jane Smith
- **ID**: 2
- **EPIC ID**: EPIC456
- **Name**: Jane Smith

## Usage Examples

### Using curl

```bash
# Get FHIR metadata
curl -u admin:admin123 http://localhost:8084/fhir/metadata

# Get all patients
curl -u admin:admin123 http://localhost:8084/fhir/Patient

# Get specific patient
curl -u admin:admin123 http://localhost:8084/fhir/Patient/1

# Health check
curl -u admin:admin123 http://localhost:8084/fhir/health

# Spring Boot health
curl -u admin:admin123 http://localhost:8084/actuator/health
```

### Using HTTP Client Libraries

#### JavaScript (fetch)
```javascript
const response = await fetch('http://localhost:8084/fhir/Patient', {
  headers: {
    'Authorization': 'Basic ' + btoa('admin:admin123'),
    'Accept': 'application/fhir+json'
  }
});
const bundle = await response.json();
```

#### Python (requests)
```python
import requests
from requests.auth import HTTPBasicAuth

response = requests.get(
    'http://localhost:8084/fhir/Patient',
    auth=HTTPBasicAuth('admin', 'admin123'),
    headers={'Accept': 'application/fhir+json'}
)
bundle = response.json()
```

## Database Schema

### Patient Table (Auto-generated by Hibernate)
```sql
CREATE TABLE patient (
    id BIGSERIAL PRIMARY KEY,
    identifier_system VARCHAR(255),
    identifier_value VARCHAR(255),
    family_name VARCHAR(255),
    given_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Development

### Local Development

#### Prerequisites
- Java 17+
- Maven 3.6+
- PostgreSQL (or use Docker)

#### Setup
```bash
cd services/fhir-server

# Install dependencies
./mvnw dependency:resolve

# Run with dev profile
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
```

#### Testing
```bash
# Run unit tests
./mvnw test

# Run with test profile
./mvnw spring-boot:run -Dspring-boot.run.profiles=test
```

### Docker Development

#### Build
```bash
docker compose build fhir-server
```

#### Run
```bash
docker compose up fhir-server -d
```

#### Logs
```bash
docker compose logs fhir-server -f
```

## Configuration Profiles

### Default Profile
- Port: 8084
- Database: PostgreSQL on postgres:5432
- Logging: INFO level

### Docker Profile
- Optimized for container deployment
- Database connection to Docker network
- Structured logging

### Development Profile
- Debug logging enabled
- H2 in-memory database option
- Development-friendly settings

## Security Considerations

### Production Deployment
1. **Change Default Credentials**
   ```yaml
   spring:
     security:
       user:
         name: ${FHIR_USERNAME}
         password: ${FHIR_PASSWORD}
   ```

2. **Enable HTTPS**
   ```yaml
   server:
     ssl:
       enabled: true
       key-store: classpath:keystore.p12
       key-store-password: ${SSL_PASSWORD}
   ```

3. **Database Security**
   - Use encrypted connections
   - Implement proper access controls
   - Regular security updates

### HIPAA Compliance
- Audit logging enabled
- Data encryption at rest and in transit
- Access controls and authentication
- Regular security assessments

## Performance Optimization

### Database Connection Pooling
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### Caching
- FHIR resource caching
- Query result caching
- Metadata caching

### Monitoring
- JVM metrics
- Database connection metrics
- Request/response times
- Error rates

## Troubleshooting

### Common Issues

#### 1. Database Connection Failed
```bash
# Check database connectivity
docker compose exec postgres pg_isready

# Verify credentials
docker compose exec postgres psql -U epic_user -d epic_db -c "SELECT 1;"
```

#### 2. Authentication Issues
```bash
# Test basic auth
curl -v -u admin:admin123 http://localhost:8084/fhir/health
```

#### 3. FHIR Validation Errors
- Check FHIR resource structure
- Verify content-type headers
- Review HAPI FHIR logs

### Logs and Debugging

#### Enable Debug Logging
```yaml
logging:
  level:
    ca.uhn.fhir: DEBUG
    org.springframework.security: DEBUG
    com.epicehr.fhir: DEBUG
```

#### View Logs
```bash
# Docker logs
docker compose logs fhir-server

# Application logs (if running locally)
tail -f logs/application.log
```

## Extending the FHIR Server

### Adding New Resources

1. **Create Resource Provider**
```java
@Component
public class ObservationResourceProvider implements IResourceProvider {
    
    @Override
    public Class<Observation> getResourceType() {
        return Observation.class;
    }
    
    @Read
    public Observation read(@IdParam IdType theId) {
        // Implementation
    }
    
    @Search
    public List<Observation> search() {
        // Implementation
    }
}
```

2. **Register in Configuration**
```java
@Configuration
public class FhirConfig {
    
    @Bean
    public RestfulServer restfulServer(ObservationResourceProvider observationProvider) {
        RestfulServer server = new RestfulServer(fhirContext);
        server.registerProvider(observationProvider);
        return server;
    }
}
```

### Custom Interceptors

```java
@Component
public class CustomInterceptor implements IServerInterceptor {
    
    @Override
    public boolean incomingRequestPreProcessed(HttpServletRequest request, HttpServletResponse response) {
        // Custom logic
        return true;
    }
}
```

## Integration with EPIC

The FHIR server is designed to be compatible with EPIC's FHIR implementation:

- EPIC-compatible patient identifiers
- Support for EPIC-specific extensions
- OAuth2 integration (via API Gateway)
- Bulk data export capabilities (planned)

## API Versioning

Current version: **1.0.0**

Future versions will maintain backward compatibility with FHIR R4 specification.
